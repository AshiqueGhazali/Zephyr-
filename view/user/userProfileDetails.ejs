<%- include('../layouts/header') %>

<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="/css/style3.css">


<body style="background-color: #f1f3f6;">

	<!-- Start Header Area -->
	<header class="header_area sticky-header">
		<div class="main_menu">
			<nav class="navbar navbar-expand-lg navbar-light main_box1">
				<div class="container">

 					<a class="navbar-brand logo_h" href="/home"><img src="/assets/img/logoWhite.png" alt=""></a>
					<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
					 aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>

                    <div class="collapse navbar-collapse offset" id="navbarSupportedContent">
						<ul class="nav navbar-nav menu_nav ml-auto">
							<li class="nav-item"><a class="nav-link1" href="/home">Home</a></li>
							<li class="nav-item"><a class="nav-link1" href="/shop">Product</a></li>
							<li class="nav-item submenu dropdown">
								<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
								 aria-expanded="false"><%= user.Fname %></a>
								<ul class="dropdown-menu">
									<li class="nav-item"><a class="nav-link" href="/profileDetails?id=<%= user._id %>">My Profile</a></li>
									<li class="nav-item"><a class="nav-link" href="/orders?id=<%= user._id %>">Orders</a></li>
									<li class="nav-item"><a class="nav-link" href="/wishlist?id=<%= user._id %>">Wishlist</a></li>
									<li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
								</ul>
							</li>
						</ul>
						<ul class="nav navbar-nav navbar-right">
							<li class="nav-item"><a href="/cart" class="cart"><span><i class="fa-solid fa-cart-shopping" style="color: #ffffff;"></i></span></a></li>
							<li class="nav-item">
								<button class="search"><span id="search"><i class="fa-solid fa-magnifying-glass" style="color: #ffffff;"></i></span></button>
							</li>
						</ul>
					</div>
				</div>
			</nav>
		</div>
		<div class="search_input" id="search_input_box">
			<div class="container">
				<form class="d-flex justify-content-between">
					<input type="text" class="form-control" id="search_input" placeholder="Search Here">
					<button type="submit" class="btn"></button>
					<span id="close_search" title="Close Search"><i class="fa-solid fa-magnifying-glass"></i></span>
				</form>
			</div>
		</div>
	</header>
	<!-- End Header Area -->

	
	<!-- End Banner Area -->
	<div class="container">
		<div class="row" style="margin-top: 154px;">
			<div class="col-xl-3 col-lg-4 col-md-5">
				<div class="sidebar-categories">
					<div class="head"><%= user.Fname %></div>
				</div>
				<div class="sidebar-categories" style="margin-top: 15px;">
					<ul class="main-categories">
						<li class="main-nav-list"><a data-toggle="collapse" href="#fruitsVegetable" aria-expanded="false" aria-controls="fruitsVegetable">
							<span class="fa-regular fa-user"></span>&nbsp;&nbsp;&nbsp;ACCOUNT SETTINGS</a>
							<ul class="collapse" id="fruitsVegetable" data-toggle="collapse" aria-expanded="false" aria-controls="fruitsVegetable">
								<li class="main-nav-list child active"><a href="/profileDetails?id=<%= user._id %>">Personal Information</a></li>
								<li class="main-nav-list child"><a href="/addressManagement?id=<%= user._id %>">Manage Addresses</a></li>								
							</ul>
				   		</li>
						<li class="main-nav-list">
							<a  href="/orders?id=<%= user._id %>" aria-expanded="false" aria-controls="fruitsVegetable">
								<span class="fa-solid fa-bag-shopping"></span>&nbsp;&nbsp;&nbsp;MY ORDERS</a>
						</li>
						<li class="main-nav-list">
							<a  href="/wishlist?id=<%= user._id %>" aria-expanded="false" aria-controls="fruitsVegetable">
								<span class="fa-regular fa-heart"></span>&nbsp;&nbsp;&nbsp;WISHLIST</a>
						</li>
						<li class="main-nav-list">
							<a  href="/waller?id=<%= user._id %>" aria-expanded="false" aria-controls="fruitsVegetable">
								<span class="fa-solid fa-wallet"></span>&nbsp;&nbsp;&nbsp;WALLET</a>
						</li>
						<li class="main-nav-list">
							<a  href="/logout" aria-expanded="false" aria-controls="fruitsVegetable">
								<span class="fa-solid fa-arrow-up-right-from-square fa-flip-horizontal"></span>&nbsp;&nbsp;&nbsp;Logout</a>
						</li>
						
					</ul>
				</div>
			</div>
			<div class="col-xl-9 col-lg-8 col-md-7" id="profileDetails">
				<div class="row" style="background-color: #ffffff; margin-bottom: 10%;">
					<div class="form-group col-lg-12 pt-3 d-flex justify-content-between align-items-center">
						<h3 class="mb-4 text-secondary">Personal Information</h3>
						<button type="button" class="btn btn-red " onclick="toggleProfileEdit()">Edit Profile</button>
					</div>
					<div class="form-group col-lg-6">
						<label for="fName">First Name</label>
						<input type="text" class="form-control" id="fName"  name="fName" placeholder="<%= user.Fname %>" readonly>
					</div>
					<div class="form-group col-lg-6">
						<label for="lName">Last Name</label>
						<input type="text" class="form-control" id="lName"  name="lName" placeholder="<%= user.Lname %>" readonly>
					</div>
					<div class="form-group col-lg-12">
						<label for="username">Username</label>
						<input type="text" class="form-control" id="username" name="username" placeholder="<%= user.username %>" readonly>
					</div>
					<div class="form-group col-lg-12">
						<label for="email">Email</label>
						<input type="text" class="form-control" id="email" name="email" placeholder="<%= user.email %>" readonly>
					</div>
					<div class="form-group col-lg-12 pb-5">
						<label for="phone">Phone</label>
						<input type="text" class="form-control" id="phone" name="phone" placeholder="<%= user.phone %>" readonly>
					</div>
				</div>
			</div>
			<div class="col-xl-9 col-lg-8 col-md-7" id="updateProfile" style="display: none;">
				<div class="row" style="background-color: #ffffff; margin-bottom: 10%;">
					<div class="col-lg-12" id="editProfile">
						<div class="form-group col-lg-12 pt-3 d-flex justify-content-between align-items-center">
						<h3 class="mb-2 text-secondary pt-3">Update Profile</h3>
						<button type="button" class="btn btn-red " onclick="toggleProfileEdit()">Cancel</button>
						</div>
						<form id="myForm" onsubmit="updateUserProfile('<%= user._id %>', event)">
							<div class="row mt-3">
								<div class="col-lg-6 mt-3">
									<label for="fName">First Name</label>
									<input type="text" class="form-control" id="fName" name="firstName" value="<%= user.Fname %>" required>
								</div> 
								<div class="col-lg-6 mt-3">
									<label for="lName">Last Name</label>
									<input type="text" class="form-control" id="lName" name="lastName" value="<%= user.Lname %>">
								</div>
							</div>
							<div class="row mt-3">
								<div class="col">
									<label for="username">Username</label>
									<input type="text" class="form-control" id="username" name="username" value="<%= user.username %>">
								</div>
							</div>
							<div class="row mt-3">
								<div class="col">
									<label for="email">Email</label>
                                	<input type="text" class="form-control" id="email" name="email" value="<%= user.email %>" readonly >
								</div>
							</div>
							<div class="row mt-2">
								<div class="col">
									<label for="phone">Phone</label>
                                	<input type="text" class="form-control" id="phone" name="phone" value="<%= user.phone %>" required>
									<input type="hidden" name="id" value="<%= user._id %>">
								</div>
							</div>
							<div class="row mt-4">
								<div class="col">
									<button type="submit" class="btn btn-blue btn-lg btn-block">Update</button>
								</div>
								<div class="col">
									<button type="button" class="btn btn-red btn-lg" onclick="clearForm()">Clear</button>
									<button type="button" class="btn btn-red btn-lg" onclick="togglePasswordChange()">Change Password</button>
								</div>
							</div>
                        </form>
						<p id="message" style="color: red;"></p>
                        <br>
                        <% if(typeof message !== "undefined"){
                            %>
                            <p style="color: brown;"><%=message%></p> 
                            <%
                        }
                        %>
                    </div>

					<!-- change password -->
					<div class="col-lg-12" style="display: none;" id="changePassword">
						<div class="form-group col-lg-12 pt-3 d-flex justify-content-between align-items-center">
						<h3 class="mb-2 text-secondary pt-3">Change Password</h3>
						<button type="button" class="btn btn-red " onclick="toggleProfileEdit()">Cancel</button>
						</div>
						<form id="myForm" onsubmit="changePassword(event)">
							<div class="row mt-3">
								<div class="col">
									<label for="currentPassword">Current Password</label>
									<input type="password" class="form-control" id="currentPassword" name="currentPassword" >
								</div>
							</div>
							<div class="row mt-3">
								<div class="col">
									<label for="newPassword">New Password</label>
									<input type="password" class="form-control" id="newPassword" name="newPassword" >
								</div>
							</div>
							<div class="row mt-3">
								<div class="col">
									<label for="confmPassword">Conform Password</label>
									<input type="password" class="form-control" id="confmPassword" name="confmPassword" >
								</div>
							</div>
							<div class="row mt-3">
								<div class="col d-flex justify-content-center align-items-center">
									<p id="message" class="" style="color: red;"></p>
								</div>
							</div>
							<div class="row mt-2">
								<div class="col">
									<button type="submit" class="btn btn-blue btn-lg btn-block">Change Password</button>
								</div>
							</div>
                        </form>
                        <br>
                        <% if(typeof message !== "undefined"){
                            %>
                            <p style="color: brown;"><%=message%></p> 
                            <%
                        }
                        %>
                    </div>
					<!-- change password end-->
			    </div>
			</div>
		</div>
	</div>


	<!-- start footer Area -->
	<footer class="footer-area section_gap">
		<div class="container">
			<div class="row">
				<div class="col-lg-3  col-md-6 col-sm-6">
					<div class="single-footer-widget">
						<h6>About</h6>
						<p><a class="About" href="">About Us</a></p>
						<p><a class="About" href="">Contact Us</a></p>
					</div>
				</div>
				<div class="col-lg-4  col-md-6 col-sm-6">
					<div class="single-footer-widget">
						<h6>Newsletter</h6>
						<p>Stay update with our latest</p>
						<div class="" id="mc_embed_signup">

							<form target="_blank" novalidate="true" action="https://spondonit.us12.list-manage.com/subscribe/post?u=1462626880ade1ac87bd9c93a&amp;id=92a4423d01"
							 method="get" class="form-inline">

								<div class="d-flex flex-row">

									<input class="form-control" name="EMAIL" placeholder="Enter Email" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Enter Email '"
									 required="" type="email">


									<button class="click-btn btn btn-default"><i class="fa fa-long-arrow-right" aria-hidden="true"></i></button>
									<div style="position: absolute; left: -5000px;">
										<input name="b_36c4fd991d266f23781ded980_aefe40901a" tabindex="-1" value="" type="text">
									</div>

									<!-- <div class="col-lg-4 col-md-4">
													<button class="bb-btn btn"><span class="lnr lnr-arrow-right"></span></button>
												</div>  -->
								</div>
								<div class="info"></div>
							</form>
						</div>
					</div>
				</div>
				<div class="col-lg-3  col-md-6 col-sm-6">
					<div class="single-footer-widget mail-chimp">
						<h6 class="mb-20">Instragram Feed</h6>
						<ul class="instafeed d-flex flex-wrap">
							<li><img src="/assets/img/i1.jpg" alt=""></li>
							<li><img src="/assets/img/i2.jpg" alt=""></li>
							<li><img src="/assets/img/i3.jpg" alt=""></li>
							<li><img src="/assets/img/i4.jpg" alt=""></li>
							<li><img src="/assets/img/i5.jpg" alt=""></li>
							<li><img src="/assets/img/i6.jpg" alt=""></li>
							<li><img src="/assets/img/i7.jpg" alt=""></li>
							<li><img src="/assets/img/i8.jpg" alt=""></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-6 col-sm-6">
					<div class="single-footer-widget">
						<h6>Follow Us</h6>
						<p>Let us be social</p>
						<div class="footer-social d-flex align-items-center">
							<a href="#"><i class="fa fa-facebook"></i></a>
							<a href="#"><i class="fa fa-twitter"></i></a>
							<a href="#"><i class="fa fa-dribbble"></i></a>
							<a href="#"><i class="fa fa-behance"></i></a>
						</div>
					</div>
				</div>
			</div>
			<div class="footer-bottom d-flex justify-content-center align-items-center flex-wrap">
				<p class="footer-text m-0"><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
&copy;<script>document.write(new Date().getFullYear());</script> - Zephyr</p>
			</div>
		</div>
	</footer>
	<!-- End footer Area -->
	<script>
		function toggleProfileEdit() {
			var changePassword = document.getElementById('changePassword')
			if(changePassword.style.display === 'block'){
				togglePasswordChange()
			}
			var profileDetails = document.getElementById('profileDetails');
			var updateProfile = document.getElementById('updateProfile');
			if (profileDetails.style.display === 'none') {
				profileDetails.style.display = 'block';
				updateProfile.style.display = 'none';
			} else {
				profileDetails.style.display = 'none';
				updateProfile.style.display = 'block';
			}
		}

		function togglePasswordChange(){
			var updateProfile = document.getElementById('editProfile')
			var changePassword = document.getElementById('changePassword')
			if(updateProfile.style.display==='none'){
				updateProfile.style.display = 'block';
				changePassword.style.display = 'none';
			}else{
				updateProfile.style.display = 'none';
				changePassword.style.display = 'block';
			}
		}

		function updateUserProfile(userId,event) {
			event.preventDefault();  

			Swal.fire({
				title: "Do you want to save the changes?",
				showDenyButton: true,
				showCancelButton: true,
				confirmButtonText: "Save",
				denyButtonText: `Don't save`,
				preConfirm: () => {
					const formData = new FormData(event.target);
					const formDataJsonString = JSON.stringify(Object.fromEntries(formData))
					return fetch(`/updateProfile`, {
						method: 'POST',
						headers:{
							'Content-Type':'application/json'
						},
						body: formDataJsonString
					})
					.then(response => {
						if (!response.ok) {
							throw new Error(response.statusText);
						}
						return response.json();
					})
					.catch(error => {
						Swal.fire("Failed!", "Changes could not be saved: " + error.message, "error");
					});
				}
			}).then((result) => {
				if (result.isConfirmed) {
					Swal.fire("Saved!", "", "success").then(() => {
						window.location.reload(); 
					});
				} else if (result.isDenied) {
					Swal.fire("Changes are not saved", "", "info");
				}
			});
     	 }

		function changePassword(event) {
			event.preventDefault(); 
			const form = document.getElementById('myForm');
			const formData = new FormData(event.target);

			const currentPassword = formData.get('currentPassword');
			const newPassword = formData.get('newPassword');
			const confirmPassword = formData.get('confmPassword');

			if (newPassword !== confirmPassword) {
				Swal.fire({
					icon: 'error',
					title: 'Passwords do not match',
					text: 'Please make sure your new passwords match.',
				});
				return;
			}

			const swalWithBootstrapButtons = Swal.mixin({
				customClass: {
					confirmButton: "btn btn-success",
					cancelButton: "btn btn-danger"
				},
				buttonsStyling: false
			});

			swalWithBootstrapButtons.fire({
				title: "Are you sure?",
				text: "You won't be able to revert this!",
				icon: "warning",
				showCancelButton: true,
				confirmButtonText: "Yes, change it!",
				cancelButtonText: "No, cancel!",
				reverseButtons: true,
			}).then((result) => {
				if (result.isConfirmed) {
					fetch('/changePassword', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ currentPassword, newPassword })
					}).then(response => {
						if (!response.ok) {
							throw response;
						}
						return response.json();
					})
					.then(data => {
						swalWithBootstrapButtons.fire({
							title: "Changed!",
							text: "Your password has been changed.",
							icon: "success"
						}).then(() => {
							location.reload();
						});
					})
					.catch(error => {
						error.json().then(err => {
							swalWithBootstrapButtons.fire({
								title: "Failed!",
								text: err.message || "There was a problem changing your password.",
								icon: "error"
							});
						});
					});
				} else if (result.dismiss === Swal.DismissReason.cancel) {
					swalWithBootstrapButtons.fire({
						title: "Cancelled",
						text: "Your password change was cancelled.",
						icon: "error"
					});
				}
			});
		}


	
	</script>

	<script src="/js/adminFormValidation.js"></script>
	<script src="/js/validation.js"></script>



<%- include('../layouts/footer') %>